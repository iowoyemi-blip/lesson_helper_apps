<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphing Quadratics (Standard Form)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        .correct-text { color: #166534; font-weight: 600; }
        .incorrect-text { color: #991b1b; font-weight: 600; }
        
        .correct-answer { border: 2px solid #22c55e; background-color: #f0fdf4; }
        .incorrect-answer { border: 2px solid #ef4444; background-color: #fef2f2; }

        /* Style for the graph */
        .graph-container {
            width: 100%;
            max-width: 500px; /* 500/20 = 25px per grid */
            margin: 0 auto;
            position: relative;
            aspect-ratio: 1 / 1;
            border: 1px solid #ccc;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: crosshair;
        }
        .graph-container svg {
            display: block;
            width: 100%;
            height: 100%;
        }
        .grid-line { stroke: #e5e7eb; stroke-width: 1; }
        .axis-line { stroke: #4b5563; stroke-width: 2; }
        .axis-label { font-family: 'Inter', sans-serif; font-size: 8px; fill: #4b5563; }
        
        .student-point {
            fill: #2563eb; /* blue-600 */
            stroke: #ffffff;
            stroke-width: 1;
        }
        .correct-parabola {
            stroke: #16a34a; /* green-600 */
            stroke-width: 3;
            fill: none;
        }

        /* Worksheet Table Styles */
        .worksheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .worksheet-table th, .worksheet-table td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            text-align: center;
        }
        .worksheet-table th {
            background-color: #f3f4f6;
        }
        .properties-table td:first-child {
            font-weight: 600;
            background-color: #f9fafb;
            width: 40%;
        }
        .worksheet-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            text-align: center;
        }
        .worksheet-input[disabled] {
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 600;
        }
        .vertex-row {
            background-color: #e5e7eb; /* gray-200 */
        }
    </style>
    <!-- Import Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div class="max-w-6xl w-full">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">Graphing Quadratics Worksheet</h1>
            <p class="text-lg text-gray-600 text-center mt-2">Graph the function and complete the properties table</p>
            <!-- Game Stats: Lives and Score -->
            <div id="game-stats" class="text-2xl font-bold text-center mt-4 text-gray-700 flex justify-center gap-6">
                <div id="lives-counter" class="text-red-500">Lives: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div id="score-counter" class="text-blue-600">Score: 0</div>
            </div>
        </header>

        <!-- Quiz Card -->
        <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl">
            <!-- Equation to Graph -->
            <div class="text-center mb-6">
                <p class="text-lg text-gray-600">Graph the following equation:</p>
                <p id="equation-display" class="text-4xl font-bold text-blue-600 my-3" style="font-family: 'Times New Roman', Times, serif;">y = x<sup>2</sup> - 4x + 3</p>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                
                <!-- Left Column: Worksheet -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Table of Values -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Table of Values</h3>
                        <p class="text-sm text-gray-500 mb-2">Find the vertex and enter it in the highlighted row. Then find 4 other points.</p>
                        <table class="worksheet-table">
                            <thead>
                                <tr><th>x</th><th>y</th></tr>
                            </thead>
                            <tbody id="values-table-body">
                                <!-- 5 rows will be injected here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Properties Table -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Properties</h3>
                        <table class="worksheet-table properties-table">
                            <tbody id="properties-table-body">
                                <tr>
                                    <td>Vertex</td>
                                    <td>
                                        <div class="flex items-center justify-center gap-1">
                                            (<input type="number" id="prop-vertex-x" class="worksheet-input w-16">,
                                            <input type="number" id="prop-vertex-y" class="worksheet-input w-16">)
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Axis of Symmetry</td>
                                    <td>
                                        <div class="flex items-center justify-center gap-1">
                                            x = <input type="number" id="prop-aos" class="worksheet-input w-16">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Min/Max</td>
                                    <td>
                                        <select id="prop-min-max" class="worksheet-input">
                                            <option value="">Select...</option>
                                            <option value="Min">Min</option>
                                            <option value="Max">Max</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>y-intercept</td>
                                    <td>
                                        <div class="flex items-center justify-center gap-1">
                                            (<input type="number" id="prop-y-int-x" class="worksheet-input w-16" value="0" disabled>,
                                            <input type="number" id="prop-y-int-y" class="worksheet-input w-16">)
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>x-intercepts</td>
                                    <td>
                                        <input type="text" id="prop-x-int" class="worksheet-input" placeholder="e.g., x=1, x=3 or None">
                                    </td>
                                </tr>
                                <tr>
                                    <td>Concavity</td>
                                    <td>
                                        <select id="prop-concavity" class="worksheet-input">
                                            <option value="">Select...</option>
                                            <option value="Up">Up</option>
                                            <option value="Down">Down</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Domain</td>
                                    <td>
                                        <input type="text" id="prop-domain" class="worksheet-input" value="All Real Numbers" disabled>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Range</td>
                                    <td>
                                        <input type="text" id="prop-range" class="worksheet-input" placeholder="e.g., y >= -1">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Graph -->
                <div class="lg:col-span-2">
                    <p id="instruction-text" class="text-lg text-gray-700 font-semibold h-6 text-center mb-2">Plot 5 points from your table.</p>
                    <div class="graph-container" id="graph-container">
                        <svg id="svg-grid" viewBox="0 0 500 500"></svg>
                    </div>
                </div>

            </div>

            <!-- Feedback & Buttons -->
            <div class="border-t border-gray-200 mt-6 pt-6">
                <div id="feedback-area" class="text-center h-6 mb-4">
                    <!-- Feedback will be injected here -->
                </div>

                <!-- Main Control Buttons -->
                <div class="grid grid-cols-1 gap-4">
                    <button id="check-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors shadow-md">
                        Check Worksheet
                    </button>
                    <button id="next-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold text-lg hover:bg-green-700 transition-colors shadow-md hidden">
                        Next Question
                    </button>
                    <button id="restart-btn" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg font-semibold text-lg hover:bg-red-700 transition-colors shadow-md hidden">
                        Restart Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const livesCounter = document.getElementById('lives-counter');
        const scoreCounter = document.getElementById('score-counter');
        const equationDisplay = document.getElementById('equation-display');
        const instructionText = document.getElementById('instruction-text');
        const graphContainer = document.getElementById('graph-container');
        const svgGrid = document.getElementById('svg-grid');
        const valuesTableBody = document.getElementById('values-table-body');
        const propertiesTableBody = document.getElementById('properties-table-body');
        const feedbackArea = document.getElementById('feedback-area');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');

        // --- Game State ---
        let lives = 3;
        let score = 0;
        let isGameOver = false;
        let currentProblem = {};
        let clickedPoints = []; // Stores {x, y} cartesian coordinates

        // --- Graphing Constants ---
        const SVG_SIZE = 500;
        const GRID_RANGE = 10; // -10 to 10
        const NUM_GRIDS = GRID_RANGE * 2; // 20
        const GRID_SIZE = SVG_SIZE / NUM_GRIDS; // 25px
        const MID = SVG_SIZE / 2;

        // --- Helper: Get Random Integer ---
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- Helper: Update Stats Display ---
        function updateStatsDisplay() {
            livesCounter.innerHTML = `Lives: ${'‚ù§Ô∏è'.repeat(lives)}${'üñ§'.repeat(3 - lives)}`;
            scoreCounter.innerHTML = `Score: ${score}`;
        }

        // --- Coordinate Conversion ---
        function toPixelCoords(cx, cy) {
            return {
                x: MID + (cx * GRID_SIZE),
                y: MID - (cy * GRID_SIZE)
            };
        }

        function toCartesianCoords(px, py) {
            return {
                x: Math.round((px - MID) / GRID_SIZE),
                y: Math.round((MID - py) / GRID_SIZE)
            };
        }

        // --- SVG Drawing ---
        function createSvgGrid() {
            svgGrid.innerHTML = ''; // Clear previous grid
            for (let i = 0; i <= NUM_GRIDS; i++) {
                let pos = i * GRID_SIZE;
                let hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                hLine.setAttribute('x1', 0); hLine.setAttribute('y1', pos);
                hLine.setAttribute('x2', SVG_SIZE); hLine.setAttribute('y2', pos);
                hLine.classList.add('grid-line');
                svgGrid.appendChild(hLine);
                let vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                vLine.setAttribute('x1', pos); vLine.setAttribute('y1', 0);
                vLine.setAttribute('x2', pos); vLine.setAttribute('y2', SVG_SIZE);
                vLine.classList.add('grid-line');
                svgGrid.appendChild(vLine);
            }
            let xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', 0); xAxis.setAttribute('y1', MID);
            xAxis.setAttribute('x2', SVG_SIZE); xAxis.setAttribute('y2', MID);
            xAxis.classList.add('axis-line');
            svgGrid.appendChild(xAxis);
            let yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', MID); yAxis.setAttribute('y1', 0);
            yAxis.setAttribute('x2', MID); yAxis.setAttribute('y2', SVG_SIZE);
            yAxis.classList.add('axis-line');
            svgGrid.appendChild(yAxis);

            function addLabel(x, y, text, align = 'middle', baseline = 'central') {
                let label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', y);
                label.setAttribute('text-anchor', align);
                label.setAttribute('dominant-baseline', baseline);
                label.textContent = text;
                label.classList.add('axis-label');
                svgGrid.appendChild(label);
            }
            for(let i = 1; i <= GRID_RANGE; i++) {
                if (i % 2 === 0) { // Label every 2 units
                    addLabel(MID + (i * GRID_SIZE), MID + 12, i); // +x
                    addLabel(MID - (i * GRID_SIZE), MID + 12, -i); // -x
                    addLabel(MID - 12, MID - (i * GRID_SIZE), i, 'end'); // +y
                    addLabel(MID - 12, MID + (i * GRID_SIZE), -i, 'end'); // -y
                }
            }
        }

        function drawPoint(cx, cy, id) {
            const p = toPixelCoords(cx, cy);
            let circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('id', id);
            circle.setAttribute('cx', p.x);
            circle.setAttribute('cy', p.y);
            circle.setAttribute('r', 4);
            circle.classList.add('student-point');
            svgGrid.appendChild(circle);
        }

        function drawParabola(a, h, k, id, lineClass) {
            let pathData = "M";
            for (let x = -GRID_RANGE; x <= GRID_RANGE; x += 0.5) {
                const y = a * Math.pow(x - h, 2) + k;
                if (y > GRID_RANGE || y < -GRID_RANGE) continue; // Stay in bounds
                const p = toPixelCoords(x, y);
                if (pathData === "M") {
                    pathData += `${p.x} ${p.y}`;
                } else {
                    pathData += ` L ${p.x} ${p.y}`;
                }
            }
            let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('id', id);
            path.setAttribute('d', pathData);
            path.classList.add(lineClass);
            svgGrid.appendChild(path);
        }

        function clearStudentDrawings() {
            clickedPoints = [];
            for (let i = 0; i < 5; i++) {
                const p = document.getElementById(`point-${i}`);
                if (p) p.remove();
            }
            const ans = document.getElementById('answer-parabola');
            if (ans) ans.remove();
        }

        // --- Problem Generation ---
        function generateProblem() {
            let a, h, k, b, c, testVal, xInt1, xInt2, xIntStr;
            
            while (true) { // Loop until we get a valid problem
                a = Math.random() < 0.5 ? 1 : -1;
                h = getRandomInt(-4, 4); // Vertex x
                k = getRandomInt(-5, 5); // Vertex y

                // Ensure a,h,k are not all 0
                if (a === 0 && h === 0 && k === 0) continue;
                
                // y = ax^2 - 2ahx + ah^2 + k
                b = -2 * a * h;
                c = a * h * h + k;

                // Check x-intercepts
                testVal = -k / a;

                // We ONLY want problems with integer intercepts, so testVal must be a perfect square.
                if (testVal >= 0) { // Check if real intercepts exist
                    let root = Math.sqrt(testVal);
                    if (Number.isInteger(root)) {
                        // This is a good problem, set intercepts and break
                        xInt1 = h + root;
                        xInt2 = h - root;
                        if (xInt1 === xInt2) {
                            xIntStr = `x=${xInt1}`;
                        } else {
                            xIntStr = [xInt1, xInt2].sort((a,b) => a-b).map(val => `x=${val}`).join(',');
                        }
                        break; // Break the loop, we found a good problem
                    }
                }
                // If testVal < 0 (no real intercepts) or root is not an integer,
                // the loop will continue and try new values for a, h, k.
            }

            // Calculate 5 points for the table
            const tablePoints = [];
            const xVals = [h-2, h-1, h, h+1, h+2];
            for (const x of xVals) {
                const y = a * Math.pow(x - h, 2) + k;
                tablePoints.push({ x, y });
            }

            // Store all solutions
            currentProblem = {
                a, b, c, h, k,
                tablePoints,
                vertex: `(${h},${k})`,
                aos: h,
                minMax: a > 0 ? "Min" : "Max",
                yInt: `(0,${c})`,
                xInt: xIntStr,
                concavity: a > 0 ? "Up" : "Down",
                range: a > 0 ? `y>=${k}` : `y<=${k}`
            };

            // --- Reset UI ---
            resetState();
            
            // Display equation
            let bStr = b === 0 ? "" : (b > 0 ? ` + ${b}x` : ` - ${Math.abs(b)}x`);
            if (b === 1) bStr = " + x";
            if (b === -1) bStr = " - x";
            let cStr = c === 0 ? "" : (c > 0 ? ` + ${c}` : ` - ${Math.abs(c)}`);
            let aStr = (a === 1) ? "x<sup>2</sup>" : (a === -1) ? "-x<sup>2</sup>" : `${a}x<sup>2</sup>`;
            equationDisplay.innerHTML = `y = ${aStr}${bStr}${cStr}`;

            // Build table
            valuesTableBody.innerHTML = "";
            tablePoints.forEach((p, index) => {
                const row = document.createElement('tr');
                if (index === 2) row.classList.add('vertex-row'); // Highlight vertex row
                row.innerHTML = `
                    <td><input type="number" class="worksheet-input x-input" id="x-input-${index}" data-index="${index}"></td>
                    <td><input type="number" class="worksheet-input y-input" id="y-input-${index}" data-index="${index}"></td>
                `;
                valuesTableBody.appendChild(row);
            });
        }
        
        // --- Game Logic ---
        function handleGraphClick(event) {
            if (clickedPoints.length >= 5 || isGameOver) return;

            const rect = svgGrid.getBoundingClientRect();
            // OLD:
            // const px = event.clientX - rect.left;
            // const py = event.clientY - rect.top;

            // NEW: Scale click coordinates to match viewBox
            const px_raw = event.clientX - rect.left;
            const py_raw = event.clientY - rect.top;
            const px = (px_raw / rect.width) * SVG_SIZE;
            const py = (py_raw / rect.height) * SVG_SIZE;
            
            const p = toCartesianCoords(px, py);
            
            drawPoint(p.x, p.y, `point-${clickedPoints.length}`);
            clickedPoints.push(p);

            if (clickedPoints.length === 5) {
                instructionText.textContent = "5 points plotted. Complete the worksheet.";
                graphContainer.style.pointerEvents = 'none';
            } else {
                instructionText.textContent = `Plot ${5 - clickedPoints.length} more points.`;
            }
        }

        function resetState() {
            clearStudentDrawings();
            graphContainer.style.pointerEvents = 'auto';
            instructionText.textContent = 'Plot 5 points from your table.';
            feedbackArea.innerHTML = '';
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            restartBtn.classList.add('hidden');
            
            // Clear all property inputs
            document.getElementById('prop-vertex-x').value = '';
            document.getElementById('prop-vertex-y').value = '';
            document.getElementById('prop-aos').value = '';
            document.getElementById('prop-min-max').value = '';
            document.getElementById('prop-y-int-y').value = '';
            document.getElementById('prop-x-int').value = '';
            document.getElementById('prop-concavity').value = '';
            document.getElementById('prop-range').value = '';

            // Remove all styling and values from tables
            document.querySelectorAll('.x-input, .y-input, .worksheet-input, .worksheet-select').forEach(el => {
                el.classList.remove('correct-answer', 'incorrect-answer');
                if (el.type !== 'select-one' && !el.disabled) {
                    el.value = '';
                }
            });
        }
        
        // Helper to normalize user input for comparison
        function normalizeInput(str) {
            return str.replace(/\s/g, '').toLowerCase();
        }

        function checkAnswer() {
            let errorMsgs = [];
            const { tablePoints, vertex, aos, minMax, yInt, xInt, concavity, range, a, h, k } = currentProblem;
            
            // 1. Check Table of Values
            let isTableCorrect = true;
            // Create a map of the 5 correct (x, y) pairs
            const correctPointsMap = new Map();
            tablePoints.forEach(p => correctPointsMap.set(p.x, p.y));
            
            for (let i = 0; i < 5; i++) {
                const xInput = document.getElementById(`x-input-${i}`);
                const yInput = document.getElementById(`y-input-${i}`);
                const userX = parseInt(xInput.value, 10);
                const userY = parseInt(yInput.value, 10);

                // Check if the (userX, userY) pair is one of the 5 correct points
                if (correctPointsMap.get(userX) === userY) {
                    xInput.classList.add('correct-answer');
                    xInput.classList.remove('incorrect-answer');
                    yInput.classList.add('correct-answer');
                    yInput.classList.remove('incorrect-answer');
                } else {
                    xInput.classList.add('incorrect-answer');
                    xInput.classList.remove('correct-answer');
                    yInput.classList.add('incorrect-answer');
                    yInput.classList.remove('correct-answer');
                    isTableCorrect = false;
                }
            }
            if (!isTableCorrect) errorMsgs.push("Check your table of values. Make sure your vertex is in the middle row and x-values are symmetric.");

            // 2. Check Plotted Points
            let isGraphCorrect = true;
            if (clickedPoints.length !== 5) {
                isGraphCorrect = false;
            } else {
                // Sort both arrays to compare
                const sortPoints = (arr) => [...arr].sort((a, b) => a.x === b.x ? a.y - b.y : a.x - b.x);
                const sortedUser = JSON.stringify(sortPoints(clickedPoints));
                const sortedAnswer = JSON.stringify(sortPoints(tablePoints));
                if (sortedUser !== sortedAnswer) {
                    isGraphCorrect = false;
                }
            }
            if (!isGraphCorrect) errorMsgs.push("Your plotted points don't match the correct table.");

            // 3. Check Properties
            let isPropertiesCorrect = true;
            const checkProp = (el, correctVal) => {
                let userVal = normalizeInput(el.value);
                // Special check for x-intercepts
                if (el.id === 'prop-x-int') {
                    const parts = userVal.split(',').sort().join(',');
                    if (parts !== correctVal) {
                        el.classList.add('incorrect-answer');
                        isPropertiesCorrect = false;
                    } else {
                        el.classList.add('correct-answer');
                        el.classList.remove('incorrect-answer');
                    }
                } else if (userVal !== normalizeInput(correctVal.toString())) {
                    el.classList.add('incorrect-answer');
                    isPropertiesCorrect = false;
                } else {
                    el.classList.add('correct-answer');
                    el.classList.remove('incorrect-answer');
                }
            };

            const userVertex = `(${document.getElementById('prop-vertex-x').value},${document.getElementById('prop-vertex-y').value})`;
            checkProp(document.getElementById('prop-vertex-x'), h); // Check x and y separately
            checkProp(document.getElementById('prop-vertex-y'), k);
            
            checkProp(document.getElementById('prop-aos'), aos);
            checkProp(document.getElementById('prop-min-max'), minMax);
            
            const userYInt = `(0,${document.getElementById('prop-y-int-y').value})`;
            checkProp(document.getElementById('prop-y-int-y'), currentProblem.c);
            
            checkProp(document.getElementById('prop-x-int'), xInt);
            checkProp(document.getElementById('prop-concavity'), concavity);
            checkProp(document.getElementById('prop-range'), range);
            
            if (!isPropertiesCorrect) errorMsgs.push("Check the properties table.");

            // --- Handle Results ---
            if (isTableCorrect && isGraphCorrect && isPropertiesCorrect) {
                score++;
                updateStatsDisplay();
                feedbackArea.innerHTML = `<p class="correct-text">Worksheet complete! Great job!</p>`;
                clearStudentDrawings();
                drawParabola(a, h, k, 'answer-parabola', 'correct-parabola');
                checkBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                lives--;
                updateStatsDisplay();
                if (lives <= 0) {
                    isGameOver = true;
                    feedbackArea.innerHTML = `<p class="incorrect-text text-xl font-bold">Game Over! Final Score: ${score}</p>`;
                    checkBtn.classList.add('hidden');
                    restartBtn.classList.remove('hidden');
                    // Show correct answers
                    clearStudentDrawings();
                    drawParabola(a, h, k, 'answer-parabola', 'correct-parabola');
                } else {
                    feedbackArea.innerHTML = `<p class="incorrect-text">${errorMsgs[0]}</p>`;
                }
            }
        }

        function handleRestart() {
            lives = 3;
            score = 0;
            isGameOver = false;
            updateStatsDisplay();
            restartBtn.classList.add('hidden');
            generateProblem();
        }

        // --- Event Listeners ---
        svgGrid.addEventListener('click', handleGraphClick);
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', generateProblem);
        restartBtn.addEventListener('click', handleRestart);

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            createSvgGrid();
            generateProblem();
            updateStatsDisplay();
        });
    </script>
</body>
</html>